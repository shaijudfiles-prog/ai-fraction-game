<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>×¤×™×§×•×“ ××©××‘×™ ×”×—×œ×œ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#00020f;color:#ddf0ff;font-family:'Segoe UI',Arial,sans-serif;
  direction:rtl;text-align:right;overflow:hidden;height:100vh;width:100vw}
canvas#stars{position:fixed;inset:0;z-index:0;pointer-events:none}
#app{position:fixed;inset:0;z-index:1;display:flex;align-items:center;justify-content:center}
.screen{width:100%;height:100%;display:none;flex-direction:column;
  align-items:center;justify-content:center;position:absolute;padding:10px;gap:10px}
.screen.active{display:flex}

/* â•â• FRACTION COMPONENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.frac{display:inline-flex;flex-direction:column;align-items:center;
  vertical-align:middle;line-height:1.05;margin:0 3px}
.frac .top{padding-bottom:2px;font-weight:700;line-height:1}
.frac .bar{width:100%;min-width:.9em;background:currentColor;border-radius:1px}
.frac .bot{padding-top:2px;font-weight:700;line-height:1}
/* sizes */
.fs .top,.fs .bot{font-size:.92em} .fs .bar{height:2px;min-width:1em}
.fm .top,.fm .bot{font-size:1.15em}.fm .bar{height:2px;min-width:1.2em}
.fl .top,.fl .bot{font-size:1.6em} .fl .bar{height:3px;min-width:1.6em}
.fx .top,.fx .bot{font-size:2.3em} .fx .bar{height:4px;min-width:2em}

/* â•â• COLORS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.nb{color:#00d4ff;text-shadow:0 0 8px #00d4ff,0 0 22px #0090ff}
.np{color:#c77dff;text-shadow:0 0 8px #c77dff,0 0 22px #9b5de5}
.nt{color:#00ffc8;text-shadow:0 0 8px #00ffc8,0 0 22px #00c896}
.ng{color:#ffd700;text-shadow:0 0 8px #ffd700,0 0 22px #cc9900}
.nr{color:#ff4d4d;text-shadow:0 0 8px #ff4d4d,0 0 22px #cc0000}

/* â•â• PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel{background:rgba(0,8,30,.9);border:1px solid rgba(0,210,255,.3);
  padding:14px 18px;position:relative;backdrop-filter:blur(5px)}
.panel::before{content:'';position:absolute;top:-1px;right:14px;left:14px;
  height:2px;background:linear-gradient(90deg,transparent,#00d4ff,transparent)}
.panel::after{content:'';position:absolute;bottom:-1px;right:14px;left:14px;
  height:2px;background:linear-gradient(90deg,transparent,#9b5de5,transparent)}

/* â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{background:linear-gradient(135deg,rgba(0,210,255,.1),rgba(155,93,229,.1));
  border:2px solid #00d4ff;color:#00d4ff;padding:11px 28px;cursor:pointer;
  font-size:1em;font-family:inherit;direction:rtl;
  transition:all .22s;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%)}
.btn:hover{background:rgba(0,210,255,.25);box-shadow:0 0 16px #00d4ff;transform:scale(1.04)}
.btn:active{transform:scale(.97)}
.btn-p{border-color:#c77dff;color:#c77dff}
.btn-p:hover{background:rgba(199,125,255,.25);box-shadow:0 0 16px #c77dff}
.btn-t{border-color:#00ffc8;color:#00ffc8}
.btn-t:hover{background:rgba(0,255,200,.25);box-shadow:0 0 16px #00ffc8}
.btn-sm{padding:7px 16px;font-size:.86em}

/* â•â• ANIMATIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.55}}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes bounceIn{0%{transform:scale(0)}60%{transform:scale(1.15)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
@keyframes correctPop{0%{transform:scale(1)}40%{transform:scale(1.18)}100%{transform:scale(1)}}
@keyframes rotSlow{to{transform:rotate(360deg)}}
@keyframes glow{0%,100%{box-shadow:0 0 6px #00d4ff}50%{box-shadow:0 0 24px #00d4ff,0 0 50px #00d4ff}}
@keyframes optIn{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
@keyframes stampIn{from{opacity:0;transform:scale(1.8) rotate(-10deg)}to{opacity:1;transform:scale(1) rotate(-6deg)}}
@keyframes capFadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* â•â• HUD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hud{position:fixed;top:0;right:0;left:0;z-index:10;display:none;
  padding:9px 16px;background:linear-gradient(180deg,rgba(0,5,20,.97) 0%,transparent 100%)}
.hrow{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.hm{flex:1;min-width:100px}
.hml{font-size:.58em;letter-spacing:1.5px;margin-bottom:3px;opacity:.8}
.mbar{height:7px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden}
.mfill{height:100%;border-radius:4px;transition:width .85s cubic-bezier(.25,.46,.45,.94)}
.ef{background:linear-gradient(90deg,#0077cc,#00d4ff);box-shadow:0 0 6px #00d4ff}
.tf{background:linear-gradient(90deg,#5500bb,#c77dff);box-shadow:0 0 6px #c77dff}
.hs{text-align:center;min-width:58px}
.hv{font-size:1.2em;font-weight:700}
.lvb{padding:3px 10px;border:1px solid rgba(0,210,255,.45);font-size:.7em;letter-spacing:1px}
.skb{padding:3px 9px;background:rgba(255,215,0,.1);border:1px solid #ffd700;
  font-size:.7em;color:#ffd700;display:none}

/* â•â• ALERT / FEEDBACK â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#abar{position:fixed;top:58px;left:50%;transform:translateX(-50%);z-index:25;
  padding:6px 20px;background:rgba(255,120,0,.17);border:1px solid #ff9900;
  color:#ff9900;font-size:.76em;letter-spacing:.8px;
  display:none;animation:fadeUp .35s ease;white-space:nowrap}
#fbo{position:fixed;inset:0;z-index:50;display:flex;align-items:center;
  justify-content:center;pointer-events:none;opacity:0;transition:opacity .28s}
#fbo.vis{opacity:1;pointer-events:all}
.fbbox{padding:22px 38px;text-align:center;max-width:440px;
  transform:scale(.4);transition:transform .36s cubic-bezier(.34,1.56,.64,1)}
.fbbox.show{transform:scale(1)}
.fbt{font-size:1.9em;font-weight:700;letter-spacing:1.5px;margin-bottom:7px}
.fbd{font-size:.85em;opacity:.82;line-height:1.8;white-space:pre-line}
.fbp{margin-top:9px;padding:7px 10px;font-size:.76em;
  border:1px solid rgba(255,215,0,.3);background:rgba(255,215,0,.06);
  color:#ffd700;line-height:1.6}

/* â•â• TIMER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.twrap{height:7px;background:rgba(255,100,0,.1);border-radius:4px;overflow:hidden;display:none}
.tfill{height:100%;border-radius:4px;background:linear-gradient(90deg,#ff4d4d,#ff9900);
  transition:width .12s linear}
.tlbl{font-size:.6em;opacity:.6;text-align:left;margin-top:2px;display:none}

/* â•â• PROGRESS DOTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pdots{display:flex;gap:6px;justify-content:center}
.pd{width:9px;height:9px;border-radius:50%;background:rgba(255,255,255,.16);transition:all .4s}
.pd.done{background:#00ffc8;box-shadow:0 0 6px #00ffc8}
.pd.cur{background:#ffd700;box-shadow:0 0 6px #ffd700;animation:pulse 1.1s infinite}

/* â•â• GAMEPLAY LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#gameplay{flex-direction:row;gap:14px;align-items:flex-start;
  justify-content:center;padding:70px 14px 12px;flex-wrap:wrap}
.gleft{flex:0 0 auto;width:310px;display:flex;flex-direction:column;gap:9px}
.gright{flex:0 0 auto;width:370px;display:flex;flex-direction:column;gap:9px}

/* Planet card */
.pcard{display:flex;align-items:center;gap:14px;animation:fadeUp .45s ease}
.porb{width:64px;height:64px;border-radius:50%;flex-shrink:0;animation:float 4s ease-in-out infinite}
.pname{font-size:1em;letter-spacing:2px;margin-bottom:2px}
.psub{font-size:.68em;opacity:.6}

/* Resource box */
.rbox{text-align:center;padding:12px 16px}
.rnum{font-size:2.8em;font-weight:700;letter-spacing:3px}
.rlbl{font-size:.6em;letter-spacing:2px;opacity:.5;margin-top:2px}

/* Fraction request */
.freqbox{text-align:center;padding:12px}
.freqlbl{font-size:.62em;letter-spacing:2px;opacity:.6;margin-bottom:8px}
.frwords{font-size:.7em;opacity:.5;margin-top:7px}

/* Estimation */
.estbox{padding:9px 12px;background:rgba(255,215,0,.05);
  border:1px solid rgba(255,215,0,.25);font-size:.78em;color:#ffd700;line-height:1.65}
.estlbl{font-size:.6em;letter-spacing:1.5px;margin-bottom:3px;opacity:.8}

/* Hint */
.hbox{padding:8px 12px;background:rgba(0,210,255,.05);
  border:1px solid rgba(0,210,255,.25);font-size:.78em;color:#88d8ff;
  line-height:1.65;display:none}
.hlbl{font-size:.6em;letter-spacing:1.5px;margin-bottom:3px;opacity:.8;color:#00d4ff}

/* â•â• VISUAL MODEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Three-step animated model showing:
   1. All N crystals
   2. Divided into equal groups (by denominator)
   3. Highlighted groups (by numerator)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.vmwrap{padding:12px}
.vmtitle{font-size:.6em;letter-spacing:1px;opacity:.5;text-align:center;margin-bottom:8px}
.vmgroups{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;
  align-items:flex-start;min-height:40px;max-width:350px;margin:0 auto}
.vmgroup{display:grid;gap:3px;padding:6px;
  border:1.5px solid transparent;border-radius:6px;
  background:transparent;transition:border-color .4s,background .4s,box-shadow .4s;
  flex-shrink:0}
.vmc{border-radius:50%;opacity:0;
  background:rgba(80,120,200,.14);border:1.5px solid rgba(80,120,200,.28);
  transition:opacity .3s,background .4s,border-color .4s,box-shadow .4s}
.vmcap{text-align:center;margin-top:9px;font-size:.84em;letter-spacing:1px;
  color:#00ffc8;text-shadow:0 0 8px #00ffc8;opacity:0;min-height:1.3em;
  transition:opacity .5s;animation:none}
.vmcap.show{animation:capFadeIn .5s ease forwards}

/* Math step display under model */
.vmstep{text-align:center;font-size:.7em;opacity:.55;letter-spacing:.5px;
  margin-top:4px;min-height:1.1em;line-height:1.5}

/* â•â• OPTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.optwrap{padding:12px}
.optlbl{font-size:.62em;letter-spacing:1.5px;opacity:.55;text-align:center;margin-bottom:8px}
.optgrid{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.obt{background:rgba(0,8,30,.75);border:2px solid rgba(0,210,255,.38);
  color:#ddf0ff;font-size:1.9em;font-weight:700;padding:16px 8px;
  cursor:pointer;text-align:center;font-family:inherit;border-radius:4px;
  transition:all .25s;animation:optIn .3s ease both}
.obt:hover{border-color:#00d4ff;box-shadow:0 0 14px rgba(0,212,255,.45);transform:scale(1.06)}
.obt:active{transform:scale(.96)}
.obt.cor{border-color:#00ffc8;background:rgba(0,255,200,.14);
  animation:correctPop .4s ease;box-shadow:0 0 20px #00ffc8}
.obt.wr{border-color:#ff4d4d;background:rgba(255,77,77,.12);
  animation:shake .38s ease;box-shadow:0 0 16px rgba(255,77,77,.4)}
.obt:nth-child(1){animation-delay:.04s}
.obt:nth-child(2){animation-delay:.09s}
.obt:nth-child(3){animation-delay:.14s}
.obt:nth-child(4){animation-delay:.19s}

/* â•â• NON-GAMEPLAY SCREENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#intro{background:radial-gradient(ellipse at center,rgba(0,12,50,.93),rgba(0,0,10,.98))}
.logo{width:96px;height:96px;border-radius:50%;border:3px solid #00d4ff;
  display:flex;align-items:center;justify-content:center;font-size:2.5em;
  animation:rotSlow 20s linear infinite,glow 3s ease-in-out infinite;
  box-shadow:0 0 24px #00d4ff,inset 0 0 24px rgba(0,210,255,.1)}
.t1{font-size:clamp(1.7em,4.5vw,3em);letter-spacing:3px;text-align:center}
.t2{font-size:.9em;letter-spacing:2px;opacity:.55;text-align:center}
.story{max-width:400px;text-align:center;font-size:.84em;opacity:.58;
  line-height:1.85;margin:6px 0 18px}

#guide{overflow-y:auto;max-height:100vh;padding:16px}
.gbody{font-size:.85em;line-height:1.9;border:1px solid rgba(0,210,255,.22);
  padding:14px 18px;background:rgba(0,8,30,.7);max-width:520px}
.gbody li{margin-bottom:5px}

#briefing{gap:12px;max-width:460px}
.brtitle{font-size:1.8em;letter-spacing:3px;text-align:center}
.brrules{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.rule{padding:4px 12px;border:1px solid rgba(0,210,255,.38);
  font-size:.7em;letter-spacing:1.5px;background:rgba(0,210,255,.05)}

#reflection{gap:14px;max-width:450px}
.refq{font-size:1.15em;letter-spacing:1px;line-height:1.7;text-align:center;color:#00ffc8}
.refopts{display:flex;flex-direction:column;gap:8px;width:100%}
.ropt{padding:11px 16px;background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.16);cursor:pointer;
  text-align:right;font-family:inherit;font-size:.84em;
  color:#ddf0ff;transition:all .25s;line-height:1.55}
.ropt:hover{border-color:#00ffc8;background:rgba(0,255,200,.09);color:#00ffc8}

/* BOSS */
#boss{gap:11px;max-width:700px;padding:70px 14px 14px;overflow-y:auto;max-height:100vh}
.bosst{font-size:1.5em;letter-spacing:4px;text-align:center;animation:pulse 2s infinite}
.bsteps{display:flex;gap:7px;justify-content:center}
.bstep{width:30px;height:30px;border-radius:50%;border:2px solid rgba(255,255,255,.22);
  display:flex;align-items:center;justify-content:center;font-size:.78em;font-weight:700;
  transition:all .45s}
.bstep.act{border-color:#ffd700;color:#ffd700;box-shadow:0 0 10px #ffd700;animation:pulse 1.2s infinite}
.bstep.don{border-color:#00ffc8;background:rgba(0,255,200,.16);color:#00ffc8}
.bcards{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.bcard{flex:1;min-width:160px;max-width:200px;padding:13px;text-align:center;
  border:2px solid rgba(199,125,255,.35);background:rgba(100,0,180,.06)}
.bcard.bact{border-color:#ffd700;box-shadow:0 0 16px rgba(255,215,0,.35)}
.bcard.bdon{border-color:#00ffc8;background:rgba(0,255,200,.06);opacity:.7}
.bctot{font-size:1.7em;font-weight:700;color:#00d4ff;margin:5px 0 2px}
.bcsub{font-size:.58em;opacity:.45;letter-spacing:1px}
.bopts{display:flex;gap:7px;flex-wrap:wrap;justify-content:center;margin-top:7px}
.bot{padding:10px 16px;border:2px solid rgba(0,210,255,.38);
  background:rgba(0,8,30,.7);cursor:pointer;font-size:1.5em;
  font-weight:700;font-family:inherit;color:#ddf0ff;
  transition:all .22s;border-radius:4px}
.bot:hover{border-color:#00d4ff;box-shadow:0 0 12px rgba(0,212,255,.45);transform:scale(1.06)}
.bot.bc{border-color:#00ffc8;background:rgba(0,255,200,.14);animation:correctPop .38s ease}
.bot.bw{border-color:#ff4d4d;animation:shake .35s ease}

/* VICTORY */
#victory{gap:14px;max-width:540px;text-align:center}
.vict{font-size:2.4em;letter-spacing:5px;animation:pulse 2s infinite}
.rank{font-size:1.6em;letter-spacing:3px;padding:14px 32px;
  border:3px solid #ffd700;background:rgba(255,215,0,.08);
  animation:stampIn .7s cubic-bezier(.34,1.56,.64,1) forwards}
.vstats{display:flex;gap:13px;flex-wrap:wrap;justify-content:center}
.sc{padding:10px 18px;border:1px solid rgba(255,255,255,.16)}
.sn{font-size:2em;font-weight:700}
.sl{font-size:.62em;letter-spacing:1.5px;opacity:.5;margin-top:2px}
.vicmsg{font-size:.84em;opacity:.62;line-height:1.8;max-width:380px}

::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(0,210,255,.28);border-radius:2px}

@media(max-width:720px){
  #gameplay{flex-direction:column;padding-top:80px}
  .gleft,.gright{width:100%;max-width:400px}
  .vmgroups{max-width:100%}
}
</style>
</head>
<body>
<canvas id="stars"></canvas>
<div id="abar"></div>
<div id="hud">
  <div class="hrow">
    <div class="hm"><div class="hml nb">âš¡ ×™×¦×™×‘×•×ª</div>
      <div class="mbar"><div class="mfill ef" id="ebar" style="width:100%"></div></div></div>
    <div class="hm"><div class="hml np">ğŸŒŒ ×××•×Ÿ</div>
      <div class="mbar"><div class="mfill tf" id="tbar" style="width:60%"></div></div></div>
    <div class="hs"><div class="hml" style="font-size:.55em">×“×¨×’×”</div>
      <div class="hv nt" id="hrank">×¦×•×¢×¨</div></div>
    <div class="lvb nb" id="hlv">×©×œ×‘ 1</div>
    <div class="lvb" id="hmode" style="background:rgba(0,255,200,.08);border-color:rgba(0,255,200,.4);color:#00ffc8;display:none"></div>
    <div class="skb" id="skb">ğŸ”¥ Ã—<span id="skv">0</span></div>
  </div>
</div>

<div id="app">

<!-- â•â• INTRO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="intro">
  <div class="logo">ğŸš€</div>
  <div class="t1 nb">×¤×™×§×•×“ ××©××‘×™ ×”×—×œ×œ</div>
  <div class="t2" style="color:rgba(220,240,255,.45)">××‘×¦×¢ ×”×¤×¦×ª ×’×‘×™×©×™ ×× ×¨×’×™×”</div>
  <p class="story">××¤×§×“/×ª â€” ×”×’×œ×§×¡×™×” ×–×§×•×§×” ×œ×“×™×•×§ ×©×œ×š!<br>
    ×›×œ ×›×•×›×‘ ××‘×§×© <strong>×©×‘×¨ ××›××•×ª</strong> ×©×œ ×’×‘×™×©×™ ×× ×¨×’×™×”.<br>
    ×—×©×‘/×™ × ×›×•×Ÿ ×›×“×™ ×œ×©××•×¨ ×¢×œ ×™×¦×™×‘×•×ª ×”×’×œ×§×¡×™×”.</p>
  <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
    <button class="btn" onclick="G.go('modeselect')">â–¶ ×”×ª×—×œ ××©×™××”</button>
    <button class="btn btn-p btn-sm" onclick="G.go('guide')">ğŸ“– ××“×¨×™×š</button>
  </div>
</div>

<!-- â•â• MODE SELECT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="modeselect">
  <div style="font-size:1.8em;letter-spacing:3px;margin-bottom:18px" class="nb">×‘×—×¨/×™ ××¦×‘</div>
  <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;max-width:700px">
    <div class="panel" style="flex:1;min-width:280px;padding:20px;cursor:pointer;transition:all .3s" 
         onclick="G.selectMode('off')" 
         onmouseover="this.style.borderColor='#00ffc8'" 
         onmouseout="this.style.borderColor='rgba(0,210,255,.3)'">
      <div style="font-size:3em;text-align:center;margin-bottom:12px">ğŸ“š</div>
      <div style="font-size:1.4em;letter-spacing:2px;text-align:center;margin-bottom:8px" class="nt">××¦×‘ ×œ××™×“×”</div>
      <div style="font-size:.82em;opacity:.75;line-height:1.8;text-align:center">
        ×œ×œ× ×˜×™×™××¨ â€¢ ×–××Ÿ ×œ×—×©×•×‘ â€¢ ××•×©×œ× ×œ×ª×¨×’×•×œ ×•×”×‘× ×”
      </div>
    </div>
    <div class="panel" style="flex:1;min-width:280px;padding:20px;cursor:pointer;transition:all .3s" 
         onclick="G.selectMode('on')" 
         onmouseover="this.style.borderColor='#ffd700'" 
         onmouseout="this.style.borderColor='rgba(0,210,255,.3)'">
      <div style="font-size:3em;text-align:center;margin-bottom:12px">âš¡</div>
      <div style="font-size:1.4em;letter-spacing:2px;text-align:center;margin-bottom:8px" class="ng">××¦×‘ ××ª×’×¨</div>
      <div style="font-size:.82em;opacity:.75;line-height:1.8;text-align:center">
        ×¢× ×˜×™×™××¨ â€¢ ×§×¦×‘ ××”×™×¨ â€¢ ×‘×“×•×§/×™ ××ª ×”××”×™×¨×•×ª ×©×œ×š!
      </div>
    </div>
  </div>
  <div style="margin-top:18px">
    <button class="btn btn-sm" onclick="G.go('intro')">â† ×—×–×¨×”</button>
  </div>
</div>

<!-- â•â• GUIDE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="guide" style="padding:14px;overflow-y:auto;max-height:100vh">
  <div class="panel" style="max-width:520px">
    <div style="font-size:1.4em;letter-spacing:2px;margin-bottom:12px" class="nb">ğŸ“– ××“×¨×™×š ×§×¦×¨</div>
    <div class="gbody">
      <ul>
        <li><strong>×”××©×™××”:</strong> ×›×œ ×›×•×›×‘ ××‘×§×© <em>×©×‘×¨ ××›××•×ª</em> ×©×œ ×’×‘×™×©×™ ×× ×¨×’×™×”.</li>
        <li><strong>×©×™×˜×” ×‘×©× ×™ ×©×œ×‘×™×:</strong>
          ×¡×š Ã· ××›× ×” = ×’×‘×™×©×™× ×‘×§×‘×•×¦×” ××—×ª,  Ã—  ××•× ×” = ×”×ª×©×•×‘×”.</li>
        <li><strong>×“×•×’××”:</strong> ×™×© <span class="nb" style="font-weight:700">10</span> ×’×‘×™×©×™×, ×”×‘×§×©×”:
          <span class="frac fl np"><span class="top">4</span><span class="bar"></span><span class="bot">5</span></span>
          â€” 10Ã·5=<span class="nt">2</span> ×‘×›×œ ×§×‘×•×¦×” â†’ 2Ã—4=<span class="ng" style="font-weight:700">8</span></li>
        <li><strong>××•×“×œ ×—×–×•×ª×™:</strong> ×ª×¨××”/×™ ××ª ×”×’×‘×™×©×™× ×•×”×§×‘×•×¦×•×ª. ×”×ª×©×•×‘×” ×”× ×›×•× ×” ×ª×•×¦×’ ×¨×§ <em>××—×¨×™</em> ×©×ª×¢× ×”/×™!</li>
        <li><strong>××¦×‘×™ ××©×—×§:</strong> ğŸ“š ××¦×‘ ×œ××™×“×” (×œ×œ× ×˜×™×™××¨) ××• âš¡ ××¦×‘ ××ª×’×¨ (×¢× ×˜×™×™××¨ ×‘×©×œ×‘ 3).</li>
        <li><strong>×©×œ×‘ 1:</strong> ×©×‘×¨×™ ×™×—×™×“×” ×‘×œ×‘×“ (Â½ â…“ Â¼ â…•) + ×¨××–×™× ××œ××™×.</li>
        <li><strong>×©×œ×‘ 2:</strong> ××•× ×” ×’×“×•×œ ×-1 (â…” Â¾ â…˜...) + ×¨××–×™× ×—×œ×§×™×™×.</li>
        <li><strong>×©×œ×‘ 3:</strong> ×©×‘×¨×™× ××’×•×•× ×™× + ×˜×™×™××¨ (×‘××¦×‘ ××ª×’×¨ ×‘×œ×‘×“).</li>
        <li><strong>Boss:</strong> 3 ×›×•×›×‘×™× ×‘×¨×¦×£ !</li>
      </ul>
    </div>
    <div style="text-align:center;margin-top:14px">
      <button class="btn btn-t" onclick="G.go('modeselect')">â–¶ ×™××œ×œ×”, ×™×•×¦××™×!</button>
    </div>
  </div>
</div>

<!-- â•â• BRIEFING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="briefing">
  <div class="brtitle nb" id="brtitle">â€”</div>
  <div class="pdots" id="brdots"></div>
  <div class="panel" style="max-width:440px">
    <p style="font-size:.86em;line-height:1.85;opacity:.82" id="brdesc"></p>
  </div>
  <div class="brrules" id="brrules"></div>
  <button class="btn" id="brbtn" onclick="G.beginLevel()">âš¡ ×¦× ×œ××©×™××”</button>
</div>

<!-- â•â• GAMEPLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="gameplay">
  <div class="gleft">
    <!-- Planet -->
    <div class="pcard"><div class="porb" id="porb"></div>
      <div><div class="pname nt" id="pname">â€”</div>
           <div class="psub" id="psub">â€”</div></div></div>
    <!-- Resource -->
    <div class="panel rbox">
      <div class="rnum nb" id="rnum">â€”</div>
      <div class="rlbl">×’×‘×™×©×™ ×× ×¨×’×™×” ×–××™× ×™×</div>
    </div>
    <!-- Fraction request -->
    <div class="panel freqbox">
      <div class="freqlbl">×”×›×•×›×‘ ××‘×§×© ×œ×§×‘×œ</div>
      <div class="frac fx np" id="freq">
        <span class="top" id="frtop">â€”</span>
        <span class="bar"></span>
        <span class="bot" id="frbot">â€”</span>
      </div>
      <div class="frwords" id="frwords"></div>
    </div>
    <!-- Estimation -->
    <div class="estbox">
      <div class="estlbl">ğŸ’­ ×”×¢×¨×›×” ×¨××©×•× ×™×ª</div>
      <div id="esttext"></div>
    </div>
    <!-- Hint -->
    <div class="hbox" id="hbox">
      <div class="hlbl">ğŸ’¡ ×¨××–</div>
      <div id="htxt"></div>
    </div>
  </div>

  <div class="gright">
    <div class="twrap" id="twrap"><div class="tfill" id="tfill" style="width:100%"></div></div>
    <div class="tlbl" id="tlbl"></div>

    <!-- â”€â”€ VISUAL MODEL: 3-step animated â”€â”€ -->
    <div class="panel vmwrap">
      <div class="vmtitle" id="vmtitle">××•×“×œ ×—×–×•×ª×™</div>
      <div class="vmgroups" id="vmgroups"></div>
      <div class="vmstep" id="vmstep"></div>
      <div class="vm-caption vmcap" id="vmcap"></div>
    </div>

    <!-- Options -->
    <div class="panel optwrap">
      <div class="optlbl">×›××” ×’×‘×™×©×™× ×œ×©×œ×•×—?</div>
      <div class="optgrid" id="optgrid"></div>
    </div>
    <div class="pdots" id="rndprog"></div>
  </div>
</div>

<!-- â•â• REFLECTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="reflection">
  <div style="font-size:.66em;letter-spacing:2px;opacity:.4">×¢×¦×™×¨×” â€” ×©××œ×ª ×—×©×™×‘×”</div>
  <div class="refq">××™×–×• ××¡×˜×¨×˜×’×™×” ×¢×–×¨×” ×œ×š ×œ××¦×•× ××ª ×”×—×œ×§ ××”×›××•×ª?</div>
  <div class="refopts">
    <div class="ropt" onclick="G.afterReflect()">ğŸ”¢ ×—×™×©×‘×ª×™: ×¡×š Ã· ××›× ×”, ×•××– Ã— ××•× ×”</div>
    <div class="ropt" onclick="G.afterReflect()">ğŸ‘ï¸ ×¡×¤×¨×ª×™ ×§×‘×•×¦×•×ª ××•×“×’×©×•×ª ×‘××•×“×œ</div>
    <div class="ropt" onclick="G.afterReflect()">ğŸ’­ ×”×¢×¨×›×ª×™ ×§×•×“× (×¤×—×•×ª ×××—×¦×™×ª? ×™×•×ª×¨?)</div>
    <div class="ropt" onclick="G.afterReflect()">ğŸ”„ ×”×©×•×•×™×ª×™ ×œ×ª×©×•×‘×” ×©××›×¨×ª×™ ×§×•×“×</div>
  </div>
  <div style="font-size:.66em;opacity:.36;margin-top:4px">×›×œ ×’×™×©×” ×ª×§×¤×” â€” ×—×©×•×‘ ×©××¦××ª ××ª ×“×¨×›×š!</div>
</div>

<!-- â•â• BOSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="boss">
  <div style="font-size:.66em;letter-spacing:2px;color:#ff4d4d">âš ï¸ ×›×•× × ×•×ª ×¢×œ×™×•× ×”</div>
  <div class="bosst nr">××©×™××ª BOSS â€” 3 ×›×•×›×‘×™×</div>
  <div class="bsteps" id="bsteps"></div>
  <div class="bcards" id="bcards"></div>
  <div class="panel vmwrap" style="max-width:420px;width:100%">
    <div class="vmtitle" id="bvmtitle">××•×“×œ</div>
    <div class="vmgroups" id="bvmgroups"></div>
    <div class="vmstep" id="bvmstep"></div>
    <div class="vmcap" id="bvmcap"></div>
  </div>
  <div class="panel" style="max-width:420px;width:100%;padding:12px 14px">
    <div style="font-size:.62em;letter-spacing:1.5px;opacity:.55;text-align:center;margin-bottom:7px">
      ×›××” ×’×‘×™×©×™× ×œ×©×œ×•×—?</div>
    <div class="bopts" id="bopts"></div>
  </div>
</div>

<!-- â•â• VICTORY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="victory">
  <div style="font-size:.66em;letter-spacing:2px;opacity:.4">âœ… ××©×™××” ×”×•×©×œ××”</div>
  <div class="vict ng">×›×œ ×”×›×‘×•×“!</div>
  <div class="rank ng" id="rankstamp">â€”</div>
  <p class="vicmsg" id="vicmsg"></p>
  <div class="vstats">
    <div class="sc"><div class="sn nb" id="svstab">â€”</div><div class="sl">×™×¦×™×‘×•×ª</div></div>
    <div class="sc"><div class="sn np" id="svtrust">â€”</div><div class="sl">×××•×Ÿ</div></div>
    <div class="sc"><div class="sn nt" id="svscore">â€”</div><div class="sl">× ×™×§×•×“</div></div>
    <div class="sc"><div class="sn ng" id="svstreak">â€”</div><div class="sl">×©×™× ×¨×¦×£</div></div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:4px">
    <button class="btn btn-t" onclick="G.go('modeselect')">ğŸ”„ ××©×™××” ×—×“×©×”</button>
    <button class="btn btn-sm" onclick="G.go('guide')">ğŸ“– ××“×¨×™×š</button>
  </div>
</div>
</div><!-- /app -->

<!-- Feedback -->
<div id="fbo"><div class="fbbox panel" id="fbbox">
  <div class="fbt" id="fbt">â€”</div>
  <div class="fbd" id="fbd"></div>
  <div class="fbp" id="fbp"></div>
</div></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STARFIELD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(()=>{
  const cv=document.getElementById('stars'),cx=cv.getContext('2d');
  let W,H,stars=[],nbs=[];
  function resize(){
    W=cv.width=innerWidth;H=cv.height=innerHeight;
    stars=Array.from({length:200},()=>({
      x:Math.random()*W,y:Math.random()*H,
      r:Math.random()*1.3+.3,s:Math.random()*.3+.08,
      o:Math.random()*.7+.2,t:Math.random()*6.28
    }));
    nbs=[
      {x:W*.18,y:H*.28,r:180,h:240},{x:W*.8,y:H*.72,r:170,h:280},
      {x:W*.52,y:H*.12,r:145,h:200},{x:W*.07,y:H*.7,r:155,h:320}
    ];
  }
  function draw(){
    cx.fillStyle='rgba(0,2,15,.17)';cx.fillRect(0,0,W,H);
    nbs.forEach(n=>{
      const g=cx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r);
      g.addColorStop(0,`hsla(${n.h},70%,26%,.04)`);g.addColorStop(1,'transparent');
      cx.fillStyle=g;cx.beginPath();cx.arc(n.x,n.y,n.r,0,Math.PI*2);cx.fill();
    });
    stars.forEach(s=>{
      s.t+=.016;s.y-=s.s;if(s.y<0)s.y=H;
      const a=s.o*(.65+.35*Math.sin(s.t));
      cx.beginPath();cx.arc(s.x,s.y,s.r,0,Math.PI*2);
      cx.fillStyle=`rgba(200,218,255,${a})`;cx.fill();
    });
    requestAnimationFrame(draw);
  }
  window.addEventListener('resize',resize);resize();draw();
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PLANETS=[
  {n:'× ×’×” ×¤×¨×™×™×',  c:'#00d4ff',bg:'radial-gradient(circle at 36% 34%,#1a607a,#00243a,#001220)'},
  {n:'× ×•×‘×¨×™×§×¡ IV', c:'#c77dff',bg:'radial-gradient(circle at 36% 34%,#5a1a80,#280048,#140022)'},
  {n:'×˜×¨×§×•×Ÿ',      c:'#00ffc8',bg:'radial-gradient(circle at 36% 34%,#1a8060,#003822,#001810)'},
  {n:'×¡×•×œ×¨×” X',    c:'#ffd700',bg:'radial-gradient(circle at 36% 34%,#806018,#3a2800,#1a1000)'},
  {n:'×©×¢×¨ ×”×©××©',   c:'#ff9966',bg:'radial-gradient(circle at 36% 34%,#7a3010,#3a0e00,#1a0500)'},
  {n:'× ×§×¡×™×¡-7',    c:'#66ccff',bg:'radial-gradient(circle at 36% 34%,#18608a,#002840,#001020)'},
];
const DW={2:'××—×¦×™×•×ª',3:'×©×œ×™×©×™×•×ª',4:'×¨×‘×¢×™×•×ª',5:'×—××™×©×™×•×ª',6:'×©×™×©×™×•×ª',8:'×©××™× ×™×•×ª',10:'×¢×©×™×¨×™×•×ª'};
const NW=['','××—×ª','×©×ª×™×™×','×©×œ×•×©','××¨×‘×¢','×—××©','×©×©','×©×‘×¢','×©××•× ×”','×ª×©×¢','×¢×©×¨'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROBLEM GENERATION
   Level 1: unit fractions ONLY (num = 1)
   Level 2: non-unit fractions (num â‰¥ 2)
   Level 3: any fraction, faster
   total = den Ã— k  â†’  perGroup = k  (always a whole number)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function genProblem(level){
  let den,k,num;
  if(level===1){
    // Unit fractions: num = 1
    den=[2,3,4,5][Math.floor(Math.random()*4)];
    k=2+Math.floor(Math.random()*3);   // k âˆˆ {2,3,4}  â†’  total âˆˆ {4..20}
    num=1;
  } else if(level===2){
    // Non-unit fractions: num â‰¥ 2
    den=[3,4,5,6][Math.floor(Math.random()*4)];
    k=2+Math.floor(Math.random()*3);   // k âˆˆ {2,3,4}
    const maxN=den-1, minN=Math.min(2,maxN);
    num=minN+Math.floor(Math.random()*(maxN-minN+1));
    num=Math.max(2,Math.min(num,den-1));
  } else {
    // Level 3 / Boss: any fraction
    den=[4,5,6,8][Math.floor(Math.random()*4)];
    const kMax=den===8?3:4;
    k=2+Math.floor(Math.random()*(kMax-1));
    num=1+Math.floor(Math.random()*(den-1));
  }
  const total=den*k;
  const ans=(total/den)*num;  // = k * num
  return {total,num,den,ans,k};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DISTRACTORS  (pedagogically meaningful)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function makeDistractors(p){
  const {total,num,den,ans}=p;
  const step=total/den;        // one group = k
  const pool=new Set([ans]);

  const tryAdd=v=>{
    const w=Math.round(v);
    if(Number.isInteger(w)&&w>0&&w<total&&w!==ans) pool.add(w);
  };
  // Common errors:
  tryAdd(step);                   // forgot to multiply (took one group)
  tryAdd(total-ans);              // complement error
  if(num>1) tryAdd(step*(num-1)); // off by one group (too few)
  tryAdd(step*(num+1));           // off by one group (too many)
  // Fallback: adjacent multiples of step
  for(let d=2;pool.size<4&&d<=den;d++){
    tryAdd(step*d);tryAdd(ans+1);tryAdd(ans-1);
  }
  // Last resort
  for(let d=1;pool.size<4;d++){
    if(ans+d<=total) pool.add(ans+d);
    if(pool.size<4&&ans-d>0) pool.add(ans-d);
  }
  return [...pool].slice(0,4).sort(()=>Math.random()-.5);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VISUAL MODEL â€” 3-step animated

   Step 1: Show exactly N crystals (staggered fade-in)
   Step 2: Group borders appear (den groups of perGroup each)
   Step 3: Highlight exactly num groups (= ans crystals) - ONLY AFTER ANSWER
   Caption: "× ×©×œ×—: [ans] ××ª×•×š [total]"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _vmTOs=[];
let _vmGroups=[];  // Store groups for post-answer highlighting
function clearVMTimers(){_vmTOs.forEach(t=>clearTimeout(t));_vmTOs=[];_vmGroups=[];}
function vmt(fn,d){_vmTOs.push(setTimeout(fn,d));}

function buildVModel(p,groupsId,stepId,capId,titleId,showAnswer){
  clearVMTimers();
  const {total,num,den,ans}=p;
  const perGroup=total/den;  // = k

  const gEl=document.getElementById(groupsId);
  const sEl=stepId?document.getElementById(stepId):null;
  const cEl=document.getElementById(capId);
  const tEl=titleId?document.getElementById(titleId):null;

  gEl.innerHTML=''; cEl.textContent=''; cEl.style.opacity='0';
  cEl.classList.remove('show');
  if(sEl) sEl.textContent='';
  if(tEl) tEl.textContent=`${total} ×’×‘×™×©×™× Ã· ${den} ×§×‘×•×¦×•×ª = ${perGroup} ×‘×›×œ ×§×‘×•×¦×”`;

  // â”€â”€ Crystal size based on total â”€â”€
  const cSz=total<=12?26:total<=16?23:total<=20?20:18;
  const cGap=3;
  // â”€â”€ Columns per group â”€â”€
  const cols = perGroup===4 ? 2 : perGroup===3 && den>4 ? 2 : perGroup;
  const gW=cols*cSz+(cols-1)*cGap+14;

  // Build groups
  const groups=[];
  for(let g=0;g<den;g++){
    const ge=document.createElement('div');
    ge.className='vmgroup';
    ge.style.gridTemplateColumns=`repeat(${cols},${cSz}px)`;
    ge.style.gap=cGap+'px';
    ge.style.width=gW+'px';
    const crystals=[];
    for(let c=0;c<perGroup;c++){
      const ce=document.createElement('div');
      ce.className='vmc';
      ce.style.width=cSz+'px'; ce.style.height=cSz+'px';
      ge.appendChild(ce); crystals.push(ce);
    }
    gEl.appendChild(ge); groups.push({el:ge,crystals});
  }
  _vmGroups=groups;  // Store for later highlighting

  // â”€â”€ PHASE 1: Crystals appear staggered â”€â”€
  const p1Dur=Math.min(550,total*26);
  const perD=Math.max(20,p1Dur/total);
  let idx=0;
  groups.forEach(g=>{
    g.crystals.forEach(c=>{
      const d=Math.round(idx*perD);
      vmt(()=>{c.style.opacity='1';},d);
      idx++;
    });
  });
  const p1End=Math.round((total-1)*perD)+100;

  // â”€â”€ PHASE 2: Group borders animate in â”€â”€
  const p2Start=p1End+120;
  groups.forEach((g,i)=>{
    vmt(()=>{
      g.el.style.borderColor='rgba(140,170,255,.32)';
      g.el.style.background='rgba(80,110,200,.06)';
    },p2Start+i*55);
  });
  const p2End=p2Start+den*55+100;

  // Show step info after groups appear
  if(sEl){
    vmt(()=>{
      sEl.textContent=`${total} Ã· ${den} = ${perGroup} ×‘×›×œ ×§×‘×•×¦×”`;
    },p2End);
  }

  // â”€â”€ PHASE 3: Highlight ONLY if showAnswer is true â”€â”€
  if(showAnswer){
    const p3Start=p2End+280;
    for(let g=0;g<num;g++){
      vmt(()=>{
        groups[g].el.style.borderColor='rgba(0,255,200,.78)';
        groups[g].el.style.background='rgba(0,255,200,.1)';
        groups[g].el.style.boxShadow='0 0 14px rgba(0,255,200,.38)';
        groups[g].crystals.forEach(c=>{
          c.style.background='rgba(0,255,200,.65)';
          c.style.borderColor='rgba(0,255,200,.95)';
          c.style.boxShadow='0 0 5px rgba(0,255,200,.65)';
        });
      },p3Start+g*75);
    }
    const p3End=p3Start+num*75+200;

    // â”€â”€ CAPTION â”€â”€
    vmt(()=>{
      cEl.textContent=`× ×©×œ×—: ${ans} ××ª×•×š ${total}`;
      cEl.style.opacity='1';
      cEl.classList.add('show');
    },p3End);
  }
}

// Show answer highlighting AFTER user answers
function showVMAnswer(p,groupsId,capId){
  const {num,ans}=p;
  const cEl=document.getElementById(capId);
  
  _vmGroups.forEach((g,i)=>{
    if(i<num){
      setTimeout(()=>{
        g.el.style.borderColor='rgba(0,255,200,.78)';
        g.el.style.background='rgba(0,255,200,.1)';
        g.el.style.boxShadow='0 0 14px rgba(0,255,200,.38)';
        g.crystals.forEach(c=>{
          c.style.background='rgba(0,255,200,.65)';
          c.style.borderColor='rgba(0,255,200,.95)';
          c.style.boxShadow='0 0 5px rgba(0,255,200,.65)';
        });
      },i*75);
    }
  });
  
  setTimeout(()=>{
    cEl.textContent=`×”×ª×©×•×‘×” ×”× ×›×•× ×”: ${ans}`;
    cEl.style.opacity='1';
    cEl.classList.add('show');
  },num*75+200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ST={
  level:1,q:0,energy:100,trust:60,score:0,
  streak:0,best:0,errCons:0,reflected:false,
  answered:false,cur:null,opts:[],
  timerSec:0,timerMax:25,timerInt:null,
  bossStep:0,bossProbs:[],
  timerMode:null,  // 'on' or 'off'
};
const LEVELS={
  1:{title:'×©×œ×‘ 1 â€” ×”×›×©×¨×”',
     desc:'×‘×¨×•×›/×” ×”×‘×/×”! ×‘×©×œ×‘ ×–×” ×ª×¢×‘×•×“/×™ ×¢× ×©×‘×¨×™ ×™×—×™×“×” ×‘×œ×‘×“: Â½, â…“, Â¼, â…•. ××¦×/×™ ×›××” ×’×‘×™×©×™× ×™×© ×‘×—×œ×§ ××—×“ ×©×•×•×” ××”×›××•×ª. ××•×“×œ ×—×–×•×ª×™ ×•×¨××–×™× ××œ××™× ×™×¡×™×™×¢×•.',
     rules:['×©×‘×¨×™ ×™×—×™×“×”','××•×“×œ ××œ×','×¨××–×™× ×–××™× ×™×','×œ×œ× ×˜×™×™××¨'],n:6},
  2:{title:'×©×œ×‘ 2 â€” ××¡×œ×•×œ ××ª×§×“×',
     desc:'×¢×›×©×™×• ×”××•× ×” ×’×“×•×œ ×-1 â€” ×›××• â…”, Â¾, â…˜. ××•×¦××™× ×›××” ×‘×§×‘×•×¦×” ××—×ª, ×•××– ×›×•×¤×œ×™× ×‘××•× ×”. ×¨××–×™× ×—×œ×§×™×™×. ×œ×¤×¢××™× ×ª×’×™×¢ ×”×ª×¨×¢×” ××™×•×—×“×ª.',
     rules:['××•× ×” > 1','×¨××–×™× ×—×œ×§×™×™×','××™×¨×•×¢×™×'],n:6},
  3:{title:'×©×œ×‘ 3 â€” ××¦×‘ ×—×™×¨×•×',
     desc:'×©×‘×¨×™× ××’×•×•× ×™× ×™×•×ª×¨. ×‘××¦×‘ ××ª×’×¨: ×˜×™×™××¨ ×¤×¢×™×œ ×•×›×œ ×˜×¢×•×ª ×¤×•×’×¢×ª ×‘×™×¦×™×‘×•×ª. ×‘××¦×‘ ×œ××™×“×”: ×–××Ÿ ×œ×œ× ×”×’×‘×œ×”. ×©××•×¨/×™ ×¢×œ ×¨×™×›×•×–!',
     rules:['×›×œ ×”×©×‘×¨×™×','×§×¦×‘ ×××ª×’×¨','×× ×¨×’×™×” ××•×’×‘×œ×ª'],n:6},
  boss:{title:'××©×™××ª BOSS',
     desc:'×©×œ×•×©×” ×›×•×›×‘×™× ×‘×•-×–×× ×™×ª! ×¢× ×”/×™ ×¢×œ ×›×œ ×‘×§×©×” ×‘×¨×¦×£. ×”×’×œ×§×¡×™×” ×¡×•××›×ª ×¢×œ×™×š ×œ×—×œ×•×˜×™×Ÿ.',
     rules:['3 ×‘×¨×¦×£','×œ×—×¥ ××§×¡×™××œ×™','×“×™×•×§ ××œ×'],n:3},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD / FEEDBACK / ALERT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showHUD(v){document.getElementById('hud').style.display=v?'block':'none';}
function updateHUD(){
  document.getElementById('ebar').style.width=ST.energy+'%';
  document.getElementById('tbar').style.width=ST.trust+'%';
  document.getElementById('hrank').textContent=ST.trust>=85?'××“×¨×™×›×œ':ST.trust>=60?'××”× ×“×¡':'×¦×•×¢×¨';
  document.getElementById('hlv').textContent=ST.level==='boss'?'BOSS':`×©×œ×‘ ${ST.level}`;
  
  // Show mode indicator
  const hm=document.getElementById('hmode');
  if(ST.timerMode){
    hm.style.display='block';
    hm.textContent=ST.timerMode==='on'?'âš¡ ××ª×’×¨':'ğŸ“š ×œ××™×“×”';
    if(ST.timerMode==='on'){
      hm.style.background='rgba(255,215,0,.08)';
      hm.style.borderColor='rgba(255,215,0,.4)';
      hm.style.color='#ffd700';
    } else {
      hm.style.background='rgba(0,255,200,.08)';
      hm.style.borderColor='rgba(0,255,200,.4)';
      hm.style.color='#00ffc8';
    }
  }
  
  const sb=document.getElementById('skb');
  if(ST.streak>=2){sb.style.display='block';document.getElementById('skv').textContent=ST.streak;}
  else sb.style.display='none';
}
let abT=null;
function showAlert(msg,dur=3200){
  const b=document.getElementById('abar');b.textContent=msg;b.style.display='block';
  if(abT)clearTimeout(abT);abT=setTimeout(()=>b.style.display='none',dur);
}
function showFB(ok,title,detail,tip){
  const ov=document.getElementById('fbo'),box=document.getElementById('fbbox');
  document.getElementById('fbt').textContent=title;
  document.getElementById('fbd').textContent=detail;
  document.getElementById('fbp').textContent=tip;
  const col=ok?'#00ffc8':'#ff4d4d';
  box.style.borderColor=col;box.style.background=ok?'rgba(0,10,28,.96)':'rgba(18,0,0,.96)';
  document.getElementById('fbt').style.color=col;
  document.getElementById('fbt').style.textShadow=`0 0 16px ${col},0 0 32px ${col}`;
  ov.classList.add('vis');setTimeout(()=>box.classList.add('show'),30);
}
function hideFB(){
  const ov=document.getElementById('fbo'),box=document.getElementById('fbbox');
  ov.classList.remove('vis');box.classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function clearTimer(){if(ST.timerInt){clearInterval(ST.timerInt);ST.timerInt=null;}}
function startTimer(onEnd){
  ST.timerSec=ST.timerMax;updateTimer();
  ST.timerInt=setInterval(()=>{ST.timerSec--;updateTimer();if(ST.timerSec<=0){clearTimer();onEnd();}},1000);
}
function updateTimer(){
  const pct=Math.max(0,ST.timerSec/ST.timerMax*100);
  const f=document.getElementById('tfill');
  f.style.width=pct+'%';
  f.style.background=pct<30?'#ff4d4d':pct<60?'linear-gradient(90deg,#ff8800,#ffcc00)':'linear-gradient(90deg,#ff4d4d,#ff9900)';
  document.getElementById('tlbl').textContent=ST.timerSec+'×©×³';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN GAME CONTROLLER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const G={
  go(sid,lvl){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(sid).classList.add('active');
    if(sid==='briefing') this._brief(lvl||ST.level);
    if(sid!=='gameplay'&&sid!=='boss') showHUD(false);
    if(sid==='intro'){showHUD(false);clearVMTimers();}
  },

  selectMode(mode){
    ST.timerMode=mode;
    this.go('briefing',1);
  },

  _brief(lvl){
    ST.level=lvl;ST.q=0;ST.reflected=false;
    if(lvl===1){ST.energy=100;ST.trust=60;ST.score=0;ST.streak=0;ST.best=0;ST.errCons=0;}
    updateHUD();
    const info=LEVELS[lvl==='boss'?'boss':lvl];
    document.getElementById('brtitle').textContent=info.title;
    document.getElementById('brdesc').textContent=info.desc;
    document.getElementById('brrules').innerHTML=info.rules.map(r=>`<span class="rule nb">${r}</span>`).join('');
    document.getElementById('brdots').innerHTML=lvl!=='boss'?
      Array.from({length:info.n},(_,i)=>`<div class="pd${i===0?' cur':''}"></div>`).join(''):'';
    document.getElementById('brbtn').textContent=lvl===1?'â–¶ ×”×ª×—×œ ×”×›×©×¨×”':'âš¡ ×¦× ×œ××©×™××”';
    showHUD(false);
  },

  beginLevel(){
    if(ST.level==='boss'){this._startBoss();return;}
    this._startQ();
  },

  _startQ(){
    clearTimer();clearVMTimers();
    const p=genProblem(ST.level);
    ST.cur=p;ST.answered=false;
    ST.opts=makeDistractors(p);
    const lvl=ST.level;

    // Planet
    const pl=PLANETS[Math.floor(Math.random()*PLANETS.length)];
    const orb=document.getElementById('porb');
    orb.style.background=pl.bg;
    orb.style.boxShadow=`0 0 20px ${pl.c},inset 0 0 20px rgba(0,0,0,.5)`;
    orb.style.animation='none';void orb.offsetWidth;orb.style.animation='float 4s ease-in-out infinite';
    document.getElementById('pname').textContent=pl.n;
    document.getElementById('pname').style.color=pl.c;
    document.getElementById('pname').style.textShadow=`0 0 8px ${pl.c}`;
    document.getElementById('psub').textContent='×©×•×œ×—/×ª ×‘×§×©×” ×œ×’×‘×™×©×™ ×× ×¨×’×™×”...';

    // Resource & fraction
    document.getElementById('rnum').textContent=p.total;
    document.getElementById('frtop').textContent=p.num;
    document.getElementById('frbot').textContent=p.den;
    document.getElementById('frwords').textContent=
      `${NW[p.num]||p.num} ${DW[p.den]||'×—×œ×§×™×'} ××ª×•×š ${p.total}`;

    // Estimation prompt (level-specific)
    const half=p.total/2;const fv=p.num/p.den;
    const cmp=fv===.5?'×‘×“×™×•×§ ×—×¦×™':fv>.5?'×™×•×ª×¨ ×××—×¦×™×ª':'×¤×—×•×ª ×××—×¦×™×ª';
    const est=document.getElementById('esttext');
    if(lvl===1){
      est.textContent=`×—×•×œ×§×™× ${p.total} ×œ-${p.den} ×§×‘×•×¦×•×ª ×©×•×•×ª â€” ×›××” ×’×‘×™×©×™× ×‘×›×œ ×§×‘×•×¦×” ××—×ª?`;
    } else {
      est.textContent=`××—×¦×™×ª ×-${p.total} ×”×™× ${half}. ×©×™×/×™ ×œ×‘: ${p.num}/${p.den} ×–×” ${cmp}.`;
    }

    // Hint (level-dependent)
    const step=p.total/p.den;
    const hbox=document.getElementById('hbox');
    if(lvl===1){
      document.getElementById('htxt').textContent=
        `${p.total} Ã· ${p.den} = ${step}. ×™×© ${step} ×’×‘×™×©×™× ×‘×—×œ×§ ××—×“.`;
      hbox.style.display='block';
    } else if(lvl===2&&Math.random()<.45){
      document.getElementById('htxt').textContent=
        `×©×œ×‘ ×: ${p.total} Ã· ${p.den} = ${step} ×‘×§×‘×•×¦×” ××—×ª.`;
      hbox.style.display='block';
    } else {
      hbox.style.display='none';
    }

    // Visual model (3-step animation - WITHOUT showing answer)
    buildVModel(p,'vmgroups','vmstep','vmcap','vmtitle',false);

    // Options
    const grid=document.getElementById('optgrid');grid.innerHTML='';
    ST.opts.forEach((v,i)=>{
      const b=document.createElement('button');b.className='obt';b.textContent=v;
      b.style.animationDelay=(i*.05)+'s';
      b.onclick=()=>this._check(v,b);
      grid.appendChild(b);
    });

    // Timer - only if timerMode is 'on' AND level 3
    const tw=document.getElementById('twrap'),tl=document.getElementById('tlbl');
    if(lvl===3 && ST.timerMode==='on'){
      ST.timerMax=22;tw.style.display='block';tl.style.display='block';
      startTimer(()=>this._timeOut());
    } else {tw.style.display='none';tl.style.display='none';}

    // Events
    if(lvl===2&&Math.random()<.3) setTimeout(()=>showAlert('ğŸŒŒ ×’×œ ×× ×¨×’×™×” ××’×™×¢ â€” ×¢×“×›×Ÿ/×™ ××”×¨!',3200),2400);
    if(lvl===3&&Math.random()<.35) setTimeout(()=>{
      ST.energy=Math.max(10,ST.energy-8);updateHUD();
      showAlert('â˜„ï¸ ×’×œ×©×ª ×¡×•×œ×¨×™×ª â€” ×™×¦×™×‘×•×ª × ×¤×’×¢×”!',3500);
    },4000+Math.random()*6000);

    // Progress
    document.getElementById('rndprog').innerHTML=
      Array.from({length:LEVELS[lvl].n},(_,i)=>
        `<div class="pd${i<ST.q?' done':i===ST.q?' cur':''}"></div>`).join('');

    updateHUD();showHUD(true);this.go('gameplay');
  },

  _check(val,btn){
    if(ST.answered)return;
    ST.answered=true;clearTimer();
    const p=ST.cur;const ok=val===p.ans;
    document.querySelectorAll('.obt').forEach(b=>b.onclick=null);
    
    // Show correct answer in model AFTER user answers
    showVMAnswer(p,'vmgroups','vmcap');
    
    document.querySelectorAll('.obt').forEach(b=>{if(+b.textContent===p.ans)b.classList.add('cor');});
    if(!ok) btn.classList.add('wr');
    const step=p.total/p.den;

    if(ok){
      ST.streak++;ST.best=Math.max(ST.best,ST.streak);ST.errCons=0;
      const bonus=ST.streak>=3?40:ST.streak>=2?20:0;
      ST.score+=100+bonus;ST.trust=Math.min(100,ST.trust+7);ST.energy=Math.min(100,ST.energy+4);
      const msgs=['âœ… ×©×™×“×•×¨ ×××•×©×¨!','ğŸ¯ ×“×™×•×§ ××•×©×œ×!','âš¡ ×§×œ×™×‘×•×¨ × ×›×•×Ÿ!','ğŸŒŸ ×—×™×©×•×‘ ××¦×•×™×Ÿ!'];
      let det=`${p.total} Ã· ${p.den} = ${step} ×‘×›×œ ×§×‘×•×¦×”\n${step} Ã— ${p.num} = ${p.ans} ×’×‘×™×©×™× âœ“`;
      if(bonus>0) det+=`\nğŸ”¥ ×‘×•× ×•×¡ ×¨×¦×£: +${bonus}!`;
      showFB(true,msgs[Math.floor(Math.random()*4)],det,'ğŸ’¡ ×©×™×˜×”: ×—×œ×§ ×‘××›× ×” ×§×•×“×, ×•××– ×”×›×¤×œ ×‘××•× ×”.');
    } else {
      ST.streak=0;ST.errCons++;
      ST.trust=Math.max(0,ST.trust-9);ST.energy=Math.max(0,ST.energy-(ST.level===3?15:10));
      showFB(false,'âš™ï¸ ×›×™×•×•× ×•×Ÿ ××¢×¨×›×ª...',
        `×”×›××•×ª ×”× ×›×•× ×”: ${p.ans}\n${p.total} Ã· ${p.den} = ${step} ×‘×›×œ ×§×‘×•×¦×”\n${step} Ã— ${p.num} = ${p.ans}`,
        'ğŸ’¡ × × ×¡×” ×©×•×‘. ×§×•×“× ×—×œ×§, ×•××– ×”×›×¤×œ. ×”××•×“×œ ××¦×™×’ ××ª ×–×” ×‘×“×™×•×§.');
    }
    updateHUD();
    if(ST.energy<=0){ST.energy=12;showAlert('âš ï¸ ×× ×¨×’×™×” ×§×¨×™×˜×™×ª! ××—×“×©×™× ××™× ×™××•×...',4000);}
    setTimeout(()=>this._afterQ(),2500);
  },

  _timeOut(){
    if(ST.answered)return;ST.answered=true;
    const p=ST.cur;const step=p.total/p.den;
    
    // Show correct answer in model
    showVMAnswer(p,'vmgroups','vmcap');
    
    ST.streak=0;ST.trust=Math.max(0,ST.trust-8);ST.energy=Math.max(0,ST.energy-14);
    showFB(false,'â° ×–××Ÿ × ×’××¨!',
      `×”×›××•×ª ×”× ×›×•× ×”: ${p.ans}\n${p.total} Ã· ${p.den} = ${step} â†’ Ã—${p.num} = ${p.ans}`,
      'ğŸ’¡ ×ª×¨×’×œ/×™ ×”×¢×¨×›×” ××”×™×¨×”: ×§×•×“× ×—×œ×§ ×‘××›× ×”.');
    updateHUD();setTimeout(()=>this._afterQ(),2500);
  },

  _afterQ(){
    hideFB();ST.q++;
    const n=LEVELS[ST.level].n;
    if(ST.level===2&&ST.q===3&&!ST.reflected){ST.reflected=true;this.go('reflection');return;}
    if(ST.q>=n){
      ST.q=0;
      if(ST.level===3) this.go('briefing','boss');
      else{ST.level++;if(ST.level>3) this.go('briefing','boss');else this.go('briefing',ST.level);}
    } else this._startQ();
  },

  afterReflect(){this._startQ();},

  /* â”€â”€ BOSS â”€â”€ */
  _startBoss(){
    ST.level='boss';ST.bossStep=0;
    ST.bossProbs=[genProblem(2),genProblem(2),genProblem(3)];
    showHUD(true);updateHUD();this._renderBoss();this.go('boss');
  },

  _renderBoss(){
    const probs=ST.bossProbs;
    // Step indicators
    document.getElementById('bsteps').innerHTML=probs.map((_,i)=>
      `<div class="bstep${i===ST.bossStep?' act':i<ST.bossStep?' don':''}">${i+1}</div>`).join('');
    // Planet cards
    document.getElementById('bcards').innerHTML=probs.map((p,i)=>{
      const pl=PLANETS[i*2%PLANETS.length];
      const done=i<ST.bossStep,active=i===ST.bossStep;
      return `<div class="bcard${active?' bact':done?' bdon':''}"
               style="${active?'border-color:#ffd700':done?'border-color:#00ffc8':''}">
        <div style="font-size:.7em;letter-spacing:2px;color:${pl.c};margin-bottom:5px">${pl.n}</div>
        <div class="bctot">${p.total}</div><div class="bcsub">×’×‘×™×©×™× ×–××™× ×™×</div>
        <div style="margin:8px 0;font-size:.85em">××‘×§×©/×ª:&nbsp;
          <span class="frac fl np"><span class="top">${p.num}</span>
          <span class="bar"></span><span class="bot">${p.den}</span></span>
        </div>
        ${done?`<div class="nt" style="font-size:1.3em;margin-top:4px">âœ“ ${p.ans}</div>`:''}
      </div>`;
    }).join('');

    if(ST.bossStep>=probs.length){setTimeout(()=>this._bossWin(),700);return;}
    const p=probs[ST.bossStep];
    clearVMTimers();
    buildVModel(p,'bvmgroups','bvmstep','bvmcap','bvmtitle',false);
    const opts=makeDistractors(p);
    const bo=document.getElementById('bopts');bo.innerHTML='';
    opts.forEach(v=>{
      const b=document.createElement('button');b.className='bot';b.textContent=v;
      b.onclick=()=>this._checkBoss(v,b,p);bo.appendChild(b);
    });
  },

  _checkBoss(val,btn,p){
    document.querySelectorAll('.bot').forEach(b=>b.onclick=null);
    
    // Show answer in boss model
    showVMAnswer(p,'bvmgroups','bvmcap');
    
    const ok=val===p.ans;
    document.querySelectorAll('.bot').forEach(b=>{if(+b.textContent===p.ans)b.classList.add('bc');});
    if(!ok){btn.classList.add('bw');ST.energy=Math.max(0,ST.energy-10);ST.trust=Math.max(0,ST.trust-8);}
    else{ST.score+=150;ST.trust=Math.min(100,ST.trust+10);}
    updateHUD();ST.bossStep++;
    setTimeout(()=>this._renderBoss(),ok?1100:1700);
  },

  _bossWin(){
    ST.score+=400;
    const rank=ST.trust>=85?'××“×¨×™×›×œ/×™×ª ×’×œ×§×˜×™/×ª':ST.trust>=60?'××”× ×“×¡/×ª ×—×œ×œ':'×¦×•×¢×¨/×ª';
    const msgs={
      '××“×¨×™×›×œ/×™×ª ×’×œ×§×˜×™/×ª':'×‘×™×¦×•×¢ ××“×”×™×! ×“×™×•×§ ××•×©×œ× ×‘×—×™×©×•×‘×™ ×©×‘×¨ ××›××•×ª. ×”×’×œ×§×¡×™×” ×‘×˜×•×—×” ×‘×™×“×™×™× ×©×œ×š!',
      '××”× ×“×¡/×ª ×—×œ×œ':'×¢×‘×•×“×” ×˜×•×‘×”! ×¨×•×‘ ×”×—×™×©×•×‘×™× ×”×™×• × ×›×•× ×™×. ×¢×•×“ ×ª×¨×’×•×œ ×•×ª×’×™×¢/×™ ×œ×“×¨×’×” ×”×’×‘×•×”×”.',
      '×¦×•×¢×¨/×ª':'×¡×™×™××ª ××ª ×”××©×™××”! ×”××©×š/×™ ×œ×ª×¨×’×œ ×©×‘×¨ ××›××•×ª ×•×ª×¢×œ×”/×™ ×‘×“×¨×’×•×ª.'
    };
    document.getElementById('rankstamp').textContent=rank;
    document.getElementById('vicmsg').textContent=msgs[rank];
    document.getElementById('svstab').textContent=Math.round(ST.energy)+'%';
    document.getElementById('svtrust').textContent=Math.round(ST.trust)+'%';
    document.getElementById('svscore').textContent=ST.score;
    document.getElementById('svstreak').textContent=ST.best;
    showHUD(false);this.go('victory');
  },
};

document.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&document.getElementById('briefing').classList.contains('active')) G.beginLevel();
});
</script>
</body>
</html>
